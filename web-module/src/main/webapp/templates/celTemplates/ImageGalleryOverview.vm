#set($title = "$!gallerydoc.getTitle()")
#set($galleryFN = $services.model.serialize($gallerydoc.documentReference, 'local'))
#set($albumobj = $!gallerydoc.getObject("XWiki.PhotoAlbumClass"))
#if("$!albumobj.getProperty('hasOverview').getValue()" != "0")
  #set($galleryLink = "$!xwiki.getURL($galleryFN, 'view')")
#else
  #set($galleryLink = "$!xwiki.getURL($galleryFN, 'view')?diapo=1")
#end
<span class="celements_gallery_link" href="$galleryLink">
#set($firstImageLink = '')
#set($gallerySpace = '')
#if($gallerydoc.attachmentList.size() > 0)
#set($attach = $gallerydoc.attachmentList.get(0))
#set($firstImageLink = $gallerydoc.getAttachmentURL($attach.filename, "download"))
#set($imgCssClasses = 'celanim_slideshow celanim_manualstart celanim_overlay celanim_addNavigation celanim_overlay_addCloseButton celimage_customStartSlide')
#elseif("$!services.pageType.getPageTypeRef($gallerydoc.documentReference).configName" == 'ImageGallery')
  #set($navObj = $!gallerydoc.getObject("Celements2.NavigationConfigClass"))
  #set($gallerySpace = $navObj.getProperty('menu_space').getValue())
  #set($gallerySlidesDocRef = $services.model.createDocumentReference('', "$!{gallerySpace}", ''))
  #set($slidesMenu = $xwiki.celementsweb.getSubNodesForParentRef($gallerySlidesDocRef.lastSpaceReference))
  #if($slidesMenu.size() > 0)
    #set($slideContent = $services.celementsweb.renderCelementsDocument($slidesMenu.get(0).documentReference))
#*
    #set($slideContentOneLine = $slideContent.replaceAll('[\n\r]',''))
    #set($imageTagInSlide = $slideContentOneLine.replaceAll('.*<img [^>]*src="([^"]*)".*', '$1'))
    #if($imageTagInSlide.indexOf('?') > 0)
      #set($imageInSlide = $imageTagInSlide.substring(0, $imageTagInSlide.indexOf('?')))
    #end
*#
##    #set($firstImageLink = $imageInSlide)
    #set($firstSlideContent = $slideContent)
  #end
  #set($imgCssClasses = "celimage_slideshow")
  #set($imgCssClasses = "${imgCssClasses} celimage_nonestart celimage_overlay ")
  #set($imgCssClasses = "${imgCssClasses} celimage_addNavigationOverlay celimage_overlay_addCloseButton")
  #set($imgCssClasses = "${imgCssClasses} celimage_overlaynonestart celimage_customStartSlide")
#end
  #if("$!imgGalcount" == '')
    #set($imgGalcount = 0)
  #end
##<!-- $doc ; $albumobj ; $albumobj.getProperty('photoWidth').getValue() ; $albumobj.getProperty('height2').getValue() -->
  #set($imgGalcount = $imgGalcount + 1)
###set($thumbWidth = "$!albumobj.getProperty('thumbWidth').getValue()")
###set($thumbHeight = "$!albumobj.getProperty('height').getValue()")
  #set($photoWidth = "$!albumobj.getProperty('photoWidth').getValue()")
  #if("$!photoWidth" == '')
    #set($photoWidth = "662")
  #end
  #set($photoHeight = "$!albumobj.getProperty('height2').getValue()")
  #if("$!photoHeight" == '')
    #set($photoHeight = "662")
  #end
  #set($thumbHeight = "100")
  #set($thumbWidth = "100")
#if("$!firstImageLink" != '')
  <img id="ImgGallery$!{imgGalcount}:${galleryFN}:1::$!{photoWidth}:$!{photoHeight}:1:$!{gallerySpace}:$!{thumbWidth}:$!{thumbHeight}"##
   class="$imgCssClasses" src="${firstImageLink}?celwidth=$!{thumbWidth}&celheight=$!{thumbHeight}&lowBound=1" alt="" />
#elseif("$firstSlideContent" != '')
  #set($zoomFactorH = $mathtool.div($!{thumbHeight}, $!{photoHeight}))
  #set($zoomFactorW = $mathtool.div($!{thumbWidth}, $!{photoWidth}))
  #set($zoomFactor = $mathtool.min($!{zoomFactorH}, $!{zoomFactorH}))
  <div id="ImgGallery$!{imgGalcount}:${galleryFN}:1::$!{photoWidth}:$!{photoHeight}:1:$!{gallerySpace}:$!{thumbWidth}:$!{thumbHeight}"##
   class="$imgCssClasses" style="width:$!{thumbWidth}px;height:$!{thumbHeight}px;">
  #*
      zoom: 2; /* all browsers */
     -moz-transform: scale(2);  /* Firefox */
     position: absolute;
     -moz-transform-origin: 0 0 0;
  *#
##      <div style="zoom: $!{zoomFactor}; -moz-transform: scale($!{zoomFactor}); -moz-transform-origin: 0 0 0;">
##        <div class="cel_slideShow_slideRoot" style="width:$!{photoWidth}px; height:$!{photoHeight}px;">
        <div class="cel_slideShow_slideRoot">
          <div class="cel_slideShow_slideWrapper"##
          style="zoom: $!{zoomFactor}; -moz-transform: scale($!{zoomFactor}); -moz-transform-origin: 0 0 0;">
          $firstSlideContent
          </div>
        </div>
##      </div>
  </div>
#else
  <span class="cel_gal_no_pictures_text">##
$adminMsg.get('cel_gal_no_pictures')##
  </span>
#end
  <span class="background"></span>
  <span class="text">$!title</span>
</span>
