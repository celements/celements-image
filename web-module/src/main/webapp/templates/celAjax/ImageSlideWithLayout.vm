#set($overwriteLayoutRef = '')
#if("$!request.overwriteLayout" != '')
#set($pageLayoutMainDocRef = $services.model.createDocumentReference('', "$!request.overwriteLayout", ''))
#set($overwriteLayoutRef = $pageLayoutMainDocRef.getLastSpaceReference())
#end
#set($galleryLayoutRef = '')
#if("$!request.galleryFN" != '')
  #set($pageLayoutMainDocRef = $services.model.resolveDocument("$!request.galleryFN"))
  #set($galleryDoc = $xwiki.getDocument($pageLayoutMainDocRef))
  #set($albumObj = $!galleryDoc.getObject("XWiki.PhotoAlbumClass"))
  #set($galleryLayout = "$!albumObj.getProperty('galleryLayout').getValue()")
#end
#if("$!galleryLayout" == '')
  #set($galleryLayoutRef = 'SimpleLayout')
#end
#set($galleryLayoutWebHomeRef = $services.model.createDocumentReference('', "$!galleryLayout", ''))
#set($galleryLayoutRef = $galleryLayoutWebHomeRef.getLastSpaceReference())
##only include if legacy celements2web.xar is installed
#if($xwiki.exists($services.model.resolveDocument('celements2web:Macros.initCelements')))
$xwiki.includeForm("celements2web:Macros.initCelements", false)
#end
#set($isAjaxCall = ("$!request.ajax" == '1'))
#if(!$isAjaxCall)
## start a Celements Document
#parse("celMacros/startCelementsDocument.vm")
##
## start the celements body (and lacily finalise the header)
#parse("celMacros/startCelementsBody.vm")
##
#end
#if($services.celementsweb.isAppScriptRequest())
#set($celAppScript = $services.celementsweb.getScriptNameFromURL())
#set($overwriteRenderDocument = 'celInlineTemplates/app.vm')
#end
#set($isCellSkin = true)
#set($doclang = $tdoc.getLanguage())
#if("$!doclang" == '')
  #set($doclang = $tdoc.getDefaultLanguage())
#end
<div class="lang_${language} doclang_$doclang">
<!-- start celements cells -->
<!-- start galleryLayoutRef : $galleryLayoutRef -->
<!-- galleryLayout : $galleryLayout -->
#if(("$!overwriteLayoutRef" != '') && $celementsweb.canRenderLayout($overwriteLayoutRef))
#set($pageContent = $celementsweb.renderPageLayout($overwriteLayoutRef))
#elseif(("$!galleryLayoutRef" != '') && $celementsweb.canRenderLayout($galleryLayoutRef))
<!-- galleryLayoutRef : $galleryLayoutRef -->
#set($pageContent = $celementsweb.renderPageLayout($galleryLayoutRef))
#else
#set($pageContent = $celementsweb.renderPageLayout())
#end
#set($maxHeight = $util.parseInt("$!request.maxHeight"))
#set($maxWidth = $util.parseInt("$!request.maxWidth"))
#if(($maxHeight > 0) || ($maxWidth > 0))
#set($pageContent = $services.celementsphoto.fixMaxImageSizes($pageContent, $maxWidth, $maxHeight))
#end
$!pageContent
<!-- end celements cells -->
</div><!-- main wrapper -->
#if(!$isAjaxCall)
#parse('celMacros/finaliseCelementsDocument.vm')
#end
